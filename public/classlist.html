<!DOCTYPE HTML>
<html>
<head>
    <!-- Required meta tags -->
    <meta charset = "utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
    
    </style>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

    <!-- <link rel="stylesheet" href="style.css"> -->



    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <!--firebase UIの読み込み-->
    <script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css" />
    <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-firestore.js"></script>


    <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      var firebaseConfig = {
        apiKey: "AIzaSyA4IUMABIg3koI5Gn9--x2igHayBwRdiig",
        authDomain: "umelab-29c16.firebaseapp.com",
        projectId: "umelab-29c16",
        storageBucket: "umelab-29c16.appspot.com",
        messagingSenderId: "444754040640",
        appId: "1:444754040640:web:f51272614f01531bc88ca5",
        measurementId: "G-CZ2P16QHER"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
    </script>

    <script src="./js/account.js"></script>

    <title>classlist</title>

    <style>
      .classDetail {
        display: table;
        width: 600px;
      }
      
      /* .detail { */
      .form-check.form-switch {
        display: table-cell;
        /* border: solid 1px #999; */
        width: 200px;
      }
    </style>
  </head>
  <body>
    <ul id="nameAccount"></ul>
    <button type="button" class="btn btn-primary" id="addBtn" onclick="signOut()">signOut</button>
    <br>
    <h1><span id="openingClass">[開講曜日・時限]</span>授業リスト</h1>
    <!-- <p>選択した講義 <span id="span1"></span></p> -->

    <!-- <div class="classtable"> -->
    <form name="classtable">
      <div class="classDetail">
        <div class="form-check form-switch">チェックボックス</div>
        <div class="form-check form-switch">ID</div>
        <div class="form-check form-switch">教科名</div>
        <div class="form-check form-switch">教授名</div>
        <!-- <div class="detail">クラスID</div>
        <div class="detail">教科名</div>
        <div class="detail">教授名</div> -->
      </div>
    </form>
    <!-- <button type="button" class="btn btn-primary" onclick="history.back()" >決定</button> -->
    <button type="button" class="btn btn-primary" onclick="confirmClass()" >決定</button>

    <script>
      const db = firebase.firestore();
      // ->URLから時限情報を取得
      let query = location.search;
      let value = query.split('=');
      const roomsDocumentId = value[2];
      console.log("表示する時限 => " + decodeURIComponent(roomsDocumentId));
      // <-

      let selectedPeriod; // "月曜1限"等の文字列
      let selectedId;     // t1m1101 とか
      let selectedClassName; // "哲学"とかの教科名
      let selectedTeacher;   // 先生の名前
      displayClass();
      
      function displayClass() {
        const openingPeriod = db.collection("rooms").doc(roomsDocumentId).collection('classes'); // 存在するclass名の値を入れないといけないのが難点
        console.log(openingPeriod);
        openingPeriod.get().then((doc) => {
            if (doc.exists) {
                document.getElementById("openingClass").textContent = doc.data()['period'];
                selectedPeriod = doc.data()['period'];
                console.log("確認　ー　" + selectedPeriod);
            } else {
                // doc.data() will be undefined in this case
                console.log("No such document!");
            }
        }).catch((error) => {
            console.log("Error getting document:", error);
        });

        

        db.collection("rooms").doc(roomsDocumentId).collection('classes').orderBy('classId').get().then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
              console.log(`${doc.id} => ${doc.data()['id']}`);
              console.log(`${doc.id} => ${doc.data()['name']}`);

              // let parent = document.getElementsByClassName("classtable")[0];
              let parent = document.classtable;

              let newRow1 = document.createElement('div');
              newRow1.setAttribute('class', 'classDetail');

                let newCB = document.createElement('div');
                newCB.setAttribute('class', 'form-check form-switch');

                  let newCBinput = document.createElement('input');
                  newCBinput.setAttribute('class', 'form-check-input');
                  newCBinput.setAttribute('type', 'checkbox');
                  newCBinput.setAttribute('id', `checkbox${doc.data()['classId']}`);   // 追加した
                  newCBinput.setAttribute('name', 'className');
                  newCBinput.setAttribute('onclick', `clickBtn(${doc.data()['classId']}, '${doc.data()['id']}', '${doc.data()['name']}', '${doc.data()['teacher']}')`);
                  // newCBinput.setAttribute('onclick', `clickBtn(${doc.data()['classId']})`);
                  let newCBlabel = document.createElement('label');
                  newCBlabel.setAttribute('class', 'form-check-label');
                  newCBlabel.setAttribute('for', 'flexSwitchCheckDefault');
                  newCB.appendChild(newCBinput);
                  newCB.appendChild(newCBlabel);

                newRow1.appendChild(newCB);

                let newDetail = document.createElement('div');
                // newDetail.setAttribute('class', 'detail');
                newDetail.setAttribute('class', 'form-check form-switch');
                newDetail.innerText = doc.data()['id'];
                newRow1.appendChild(newDetail);

                newDetail = document.createElement('div');
                // newDetail.setAttribute('class', 'detail');
                newDetail.setAttribute('class', 'form-check form-switch');
                newDetail.innerText = doc.data()['name'];
                newRow1.appendChild(newDetail);

                newDetail = document.createElement('div');
                // newDetail.setAttribute('class', 'detail');
                newDetail.setAttribute('class', 'form-check form-switch');
                newDetail.innerText = doc.data()['teacher'];
                newRow1.appendChild(newDetail);

              parent.appendChild(newRow1);
              console.log(parent);

          });
        });
      }

      function clickBtn(classId, id, name, teacher){
        const className = document.classtable.className;
        for (let i = 0; i < className.length; i++){
          if(className[i].id == "checkbox"+classId){
            selectedId = id;
            selectedClassName = name;
            selectedTeacher = teacher;
            console.log("id -> " + id);
            console.log("name -> " + name);
            console.log("teacher -> " + teacher);
            continue;
          }
          className[i].checked = false;
        }

        // データを保存
        sessionStorage.setItem('loginUser', selectedClassName);

        //データを取得
        var data = sessionStorage.getItem('loginUser');
        console.log(data);
      }

      function confirmClass(){
        const className = document.classtable.className;
        let msg = "";
        for (let i = 0; i < className.length; i++){
          if(className[i].checked){
            // console.log(className[i]);
            msg = `このクラスを選択しますか？\n${selectedPeriod}\n- ID：${selectedId} \n- 教科名：${selectedClassName} \n- 教授名：${selectedTeacher}`;
            break;
          }
        }
        if (window.confirm(msg)) {
          db.collection("rooms").doc(roomsDocumentId).collection("classes")
          .get().then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              if (doc.data()['id'] == selectedId) {
                doc.collection("users").add({
                  uid: uid
                })
                .then(() => {
                  console.log("Document written with ID: ");
                })
                .catch((error) => {
                  console.error("Error writing document: ", error);
                });
              }
            })
          })

          // window.location.href ='../timetable.html?name=' + encodeURIComponent(uid);
        } else {

        }
      }

    </script>
  </body>
</html>